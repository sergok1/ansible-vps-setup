---
# Настройка автоматического обновления системы

- name: Установка unattended-upgrades
  ansible.builtin.apt:
    name:
      - unattended-upgrades
      - apt-listchanges
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Настройка автообновлений
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'

- name: Настройка расписания автообновлений
  ansible.builtin.template:
    src: 20auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: '0644'

- name: Создание cron задачи для обновления по расписанию
  ansible.builtin.cron:
    name: "Автообновление системы"
    user: root
    minute: "{{ auto_update_minute }}"
    hour: "{{ auto_update_hour }}"
    weekday: "{{ auto_update_weekday }}"
    job: "/usr/bin/unattended-upgrade -v >> /var/log/unattended-upgrades/cron.log 2>&1"
    state: present
  when: auto_update_use_cron | default(true)

- name: Создание директории для логов
  ansible.builtin.file:
    path: /var/log/unattended-upgrades
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Включение службы unattended-upgrades
  ansible.builtin.service:
    name: unattended-upgrades
    state: started
    enabled: true
